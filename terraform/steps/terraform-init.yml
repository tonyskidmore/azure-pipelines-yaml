---

parameters:
  - name: terraformDirectory
    type: string
  - name: terraformVersion
    type: string
  - name: checkout
    type: object

steps:

  - task: Cache@2
    displayName: 'Register init cache'
    inputs:
      key: 'terraform | init | "$(Agent.OS)" | "$(Build.BuildNumber)" | "$(Build.SourceVersion)"'
      path: $(System.DefaultWorkingDirectory)

  - ${{ if gt(length(parameters.checkout), 1) }}:
    - ${{ each repo in parameters.checkout }}:
      - checkout: ${{ repo }}
  - ${{ else }}:
    - checkout: self

  - script: |
      env
      ls "$SYSTEM_DEFAULTWORKINGDIRECTORY"
    displayName: Debug

  - task: Bash@3
    inputs:
      filePath: 'terraform-install.sh'
      arguments: '${{ parameters.terraformVersion }}'
      workingDirectory: '$(System.WorkingDirectory)/pipelines/terraform/scripts'
      failOnStderr: true
      # bashEnvValue: 'tony=good'
    displayName: 'Install Terraform: ${{ parameters.terraformVersion }}'

  - task: Bash@3
    inputs:
      filePath: 'terraform-init.sh'
      arguments: '${{ parameters.terraformDirectory }}'
      workingDirectory: '$(System.WorkingDirectory)/pipelines/terraform/scripts'
      failOnStderr: true
      # bashEnvValue: 'tony=good'
    displayName: 'Run terraform init'
