---

parameters:
  - name: poolName
    type: string
    default: 'Azure Pipelines'
  - name: environments
    type: object
    default:
      - demo
  - name: environmentParameters
    type: object
    default:
      demo:
        dependsOn: []
        environmentName: "demo"
      dev:
        dependsOn: []
        environmentName: "dev"
      test:
        dependsOn: [dev]
        environmentName: "test"
      prod:
        dependsOn: [dev, test]
        environmentName: "prod"
  - name: dependsOn
    type: object
    default: []
  - name: stages
    type: object
    default:
      - init_plan
      - apply
  - name: stageParameters
    type: object
    default:
      init_plan:
        dependsOn: []
        # condition: and(succeeded(), eq(variables['build.sourceBranch'], 'refs/heads/main'))
        condition: succeeded()
        stageName: "init_plan"
      # plan:
      #   dependsOn: [init]
      #   # condition: and(succeeded(), eq(variables['build.sourceBranch'], 'refs/heads/main'))
      #   condition: succeeded()
      #   stageName: "plan"
      apply:
        dependsOn: [init_plan]
        # condition: and(succeeded(), eq(variables['build.sourceBranch'], 'refs/heads/main'))
        condition: succeeded()
        stageName: "apply"
      destroy:
        dependsOn: [init_plan]
        # condition: and(succeeded(), eq(variables['build.sourceBranch'], 'refs/heads/main'))
        condition: succeeded()
        stageName: "destroy"

stages:

  - template: stages/terraform-environments.yml
    parameters:
      environments: ${{ parameters.environments }}
      environmentParameters: ${{ parameters.environmentParameters }}
      dependsOn: ${{ parameters.dependsOn }}
      stages: ${{ parameters.stages }}
      stageParameters: ${{ parameters.stageParameters }}
      poolName: ${{ parameters.poolName }}
