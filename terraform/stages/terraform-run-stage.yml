---

parameters:
  - name: poolName
    type: string
  - name: dependsOn
    type: object
  - name: parentDependsOn
    type: object
  - name: environment
    type: string
  - name: environmentName
    type: string
  - name: environmentDependsOn
    type: object
  - name: condition
    type: string
  - name: stage
    type: string
  - name: stageName
    type: string
  - name: checkout
    type: object


stages:
  - stage: ${{ parameters.environment }}_${{ parameters.stageName }}
    # displayName: upper(parameters.targetEnvironmentName)
    pool:
      name: ${{ parameters.poolName }}
    dependsOn:
      - ${{ each depParent in parameters.parentDependsOn }}:
        - ${{ depParent }}
      - ${{ each depEnv in parameters.environmentDependsOn }}:
        - ${{ each dep in parameters.dependsOn }}:
          - ${{ depEnv }}_${{ dep }}
      - ${{ each dep in parameters.dependsOn }}:
        - ${{ parameters.environmentName }}_${{ dep }}
    condition: ${{ parameters.condition }}
    jobs:
    - ${{ if eq(parameters['stage'], 'init_plan') }}:
      - template: ../jobs/init_plan.yml
        parameters:
          checkout: ${{ parameters.checkout}}
    - ${{ if eq(parameters['stage'], 'apply') }}:
      - template: ../jobs/apply.yml
        parameters:
          poolName: ${{ parameters.poolName }}
          environmentName: ${{ parameters.environmentName }}
    - ${{ if eq(parameters['stage'], 'destroy') }}:
      - template: ../jobs/destroy.yml
        parameters:
          poolName: ${{ parameters.poolName }}
          environmentName: ${{ parameters.environmentName }}

    # dependsOn:
    #   - ${{ each depParent in parameters.parentDependsOn }}:
    #     - ${{ depParent }}
    #   - ${{ each dep in parameters.dependsOn }}:
    #     - ${{ each depEnv in parameters.environmentDependsOn }}:
    #       - ${{ depEnv }}_${{ dep }}
    #     - ${{ parameters.environmentName }}_${{ dep }}