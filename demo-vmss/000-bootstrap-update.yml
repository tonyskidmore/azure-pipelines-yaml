---

name: "bootstrap"

parameters:
- name: operation
  displayName: Bootstrap Operation
  type: string
  default: terraform-plan-apply
  values:
  - first-time-only
  - terraform-plan-apply
  - terraform-destroy

trigger: none

variables:
- group: build
- name: serviceConnection
  value: "demo-vmss"
# - name: containerImage
#   value: "ghcr.io/tonyskidmore/azdo-container-image:latest"

pool:
  name: 'vmss-bootstrap-pool'


# resources:
#   containers:
#     - container: ubuntu20_04
#       image: '${{ variables.containerImage }}'

stages:
- ${{ if eq(parameters.operation, 'first-time-only') }}:
  - stage: update
    # condition: eq('${{ parameters.operation }}', 'first-time-only')

    jobs:
      - job: update
        displayName: "Update Terraform Code"
        continueOnError: false
        # container: ubuntu20_04

        steps:

          # - checkout: self
          # - checkout: git://$(project)/module

          - script: |
              env
              ls "$SYSTEM_DEFAULTWORKINGDIRECTORY"
            displayName: Debug

- template: ../terraform/terraform.yml
  parameters:
    azureSubscription: '${{ variables.serviceConnection }}'
    # container: ubuntu20_04
    ${{ if eq('${{ parameters.operation }}', 'terraform-destroy') }}:
      destroyMode: true
    initCheckout:
      - self
      # TODO:
      - git://$(project)/module@refs/heads/examples
      # - git://$(project)/module
    ${{ if eq(parameters.operation, 'first-time-only') }}:
      dependsOn:
        - update
    poolName: 'vmss-bootstrap-pool'
    ${{ if eq(parameters.operation, 'terraform-destroy') }}:
      stages:
        - init_plan
        - destroy
    terraformDirectory: '$(System.DefaultWorkingDirectory)/module/demo_environment'
    terraformTfVars:
      AZ_SUBSCRIPTION: $(azurerm_subscription_id)
      AZDO_PERSONAL_ACCESS_TOKEN: $(ado_ext_pat)
      AZDO_ORG_SERVICE_URL: $(ado_org)
      TF_VAR_ado_ext_pat: $(ado_ext_pat)
      TF_VAR_ado_org: $(ado_org)
      TF_VAR_azurerm_subscription_id: $(azurerm_subscription_id)
      TF_VAR_azurerm_spn_tenantid: $(azurerm_spn_tenantid)
      TF_VAR_serviceprincipalid: $(serviceprincipalid)
      TF_VAR_serviceprincipalkey: $(serviceprincipalkey)
